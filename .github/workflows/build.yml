---

name: Build
on:
  push:
    branches:
      - github-workflow
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      ##
      ## Start notification
      ##

      - name: Notify Slack start
        uses: voxmedia/github-action-slack-notify-build@v1
        id: slack
        with:
          channel: dev-log
          status: STARTING
          color: warning
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_NOTIFICATIONS_BOT_TOKEN }}

      ##
      ## Checkout repo
      ##

      - name: Checkout repo
        uses: actions/checkout@v2
        with:
          submodules: recursive

      ##
      ## Setup
      ##

      - name: Install Ubuntu packages
        run: sudo apt-get install -y build-essential cmake git libgmp-dev libsqlite3-dev libssl1.1

      ##
      ## Run test
      ##

      - name: Run tests
        run: DOCKER_BUILDKIT=1 docker build --target test .

      ##
      ## Image build and push setup
      ##

      - name: Log in to GitHub Docker Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Voom version release number to environment
        run: |
          echo "VOOM_VERSION=$(./voom-like-version)" >>${GITHUB_ENV}
          echo "RELEASE_NUMBER=$(cat RELEASE_NUMBER)" >>${GITHUB_ENV}

      ##
      ## Build and push container image
      ##

      - name: Build and push container image
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: |
            ghcr.io/strongpool/arweave:${{ env.RELEASE_NUMBER }}-strongpool-${{ env.VOOM_VERSION }}
            ghcr.io/strongpool/arweave:latest

      ##
      ## Slack completion notifications
      ##

      # Updates existing message from the first step
      - name: Notify Slack success
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_NOTIFICATIONS_BOT_TOKEN }}
        uses: voxmedia/github-action-slack-notify-build@v1
        with:
          message_id: ${{ steps.slack.outputs.message_id }}
          channel: dev-log
          status: SUCCESS
          color: good

      # Updates existing message from the first step
      - name: Notify Slack failure
        if: failure()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_NOTIFICATIONS_BOT_TOKEN }}
        uses: voxmedia/github-action-slack-notify-build@v1
        with:
          message_id: ${{ steps.slack.outputs.message_id }}
          channel: dev-log
          status: FAILED
          color: danger

      # For notification purposes, sends to a separate channel on failure
      - name: Notify Slack failure (build failures channel)
        if: failure()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_NOTIFICATIONS_BOT_TOKEN }}
        uses: voxmedia/github-action-slack-notify-build@v1
        with:
          channel: build-failures
          status: FAILED
          color: danger

      ##
      ## Discord completion notifications
      ##

      - name: Notify Discord failure
        uses: rjstone/discord-webhook-notify@v1
        if: failure()
        with:
          severity: error
          details: Build failed!
          webhookUrl: ${{ secrets.DISCORD_DEV_LOG_WEBHOOK }}

      - name: Notify Discord canceled
        uses: rjstone/discord-webhook-notify@v1
        if: cancelled()
        with:
          severity: warn
          details: Build canceled!
          webhookUrl: ${{ secrets.DISCORD_DEV_LOG_WEBHOOK }}
